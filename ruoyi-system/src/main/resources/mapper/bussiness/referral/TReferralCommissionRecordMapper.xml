<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"com.ruoyi.bussiness.mapper.referral.TReferralCommissionRecordMapper\">\n    \n    <resultMap type=\"TReferralCommissionRecord\" id=\"TReferralCommissionRecordResult\">\n        <result property=\"id\" column=\"id\" />\n        <result property=\"orderId\" column=\"order_id\" />\n        <result property=\"recipientUserId\" column=\"recipient_user_id\" />\n        <result property=\"payerUserId\" column=\"payer_user_id\" />\n        <result property=\"commissionAmount\" column=\"commission_amount\" />\n        <result property=\"commissionLevel\" column=\"commission_level\" />\n        <result property=\"commissionRate\" column=\"commission_rate\" />\n        <result property=\"status\" column=\"status\" />\n        <result property=\"transactionId\" column=\"transaction_id\" />\n        <result property=\"createdAt\" column=\"created_at\" />\n        <result property=\"processedAt\" column=\"processed_at\" />\n        <result property=\"currency\" column=\"currency\" />\n        <result property=\"remarks\" column=\"remarks\" />\n        <result property=\"referralPath\" column=\"referral_path\" />\n        <result property=\"version\" column=\"version\" />\n        <result property=\"deleted\" column=\"deleted\" />\n    </resultMap>\n    \n    <sql id=\"selectTReferralCommissionRecordVo\">\n        SELECT id, order_id, recipient_user_id, payer_user_id, commission_amount, commission_level, \n               commission_rate, status, transaction_id, created_at, processed_at, currency, \n               remarks, referral_path, version, deleted\n        FROM t_referral_commission_record\n    </sql>\n    \n    <!-- 根据订单ID查询佣金记录 -->\n    <select id=\"selectByOrderId\" parameterType=\"Long\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE order_id = #{orderId} AND deleted = 0\n        ORDER BY commission_level ASC\n    </select>\n    \n    <!-- 根据接收用户ID查询佣金记录 -->\n    <select id=\"selectByRecipientUserId\" parameterType=\"Long\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE recipient_user_id = #{recipientUserId} AND deleted = 0\n        ORDER BY created_at DESC\n    </select>\n    \n    <!-- 根据产生佣金用户ID查询佣金记录 -->\n    <select id=\"selectByPayerUserId\" parameterType=\"Long\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE payer_user_id = #{payerUserId} AND deleted = 0\n        ORDER BY created_at DESC\n    </select>\n    \n    <!-- 根据状态查询佣金记录 -->\n    <select id=\"selectByStatus\" parameterType=\"String\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE status = #{status} AND deleted = 0\n        ORDER BY created_at ASC\n    </select>\n    \n    <!-- 根据佣金层级查询佣金记录 -->\n    <select id=\"selectByCommissionLevel\" parameterType=\"Integer\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE commission_level = #{commissionLevel} AND deleted = 0\n        ORDER BY created_at DESC\n    </select>\n    \n    <!-- 根据时间范围查询佣金记录 -->\n    <select id=\"selectByDateRange\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE deleted = 0\n        <if test=\"startDate != null\">\n            AND created_at >= #{startDate}\n        </if>\n        <if test=\"endDate != null\">\n            AND created_at <= #{endDate}\n        </if>\n        ORDER BY created_at DESC\n    </select>\n    \n    <!-- 查询用户的佣金统计信息 -->\n    <select id=\"selectCommissionSumByUser\" resultType=\"java.math.BigDecimal\">\n        SELECT COALESCE(SUM(commission_amount), 0)\n        FROM t_referral_commission_record\n        WHERE recipient_user_id = #{recipientUserId} AND deleted = 0\n        <if test=\"startDate != null\">\n            AND created_at >= #{startDate}\n        </if>\n        <if test=\"endDate != null\">\n            AND created_at <= #{endDate}\n        </if>\n    </select>\n    \n    <!-- 查询用户按级别的佣金统计 -->\n    <select id=\"selectCommissionSumByUserAndLevel\" resultType=\"java.math.BigDecimal\">\n        SELECT COALESCE(SUM(commission_amount), 0)\n        FROM t_referral_commission_record\n        WHERE recipient_user_id = #{recipientUserId} \n          AND commission_level = #{commissionLevel} \n          AND deleted = 0\n        <if test=\"startDate != null\">\n            AND created_at >= #{startDate}\n        </if>\n        <if test=\"endDate != null\">\n            AND created_at <= #{endDate}\n        </if>\n    </select>\n    \n    <!-- 查询用户的佣金记录数量 -->\n    <select id=\"countByUserAndStatus\" resultType=\"Integer\">\n        SELECT COUNT(*)\n        FROM t_referral_commission_record\n        WHERE recipient_user_id = #{recipientUserId} AND deleted = 0\n        <if test=\"status != null and status != ''\">\n            AND status = #{status}\n        </if>\n    </select>\n    \n    <!-- 批量插入佣金记录 -->\n    <insert id=\"insertBatch\" parameterType=\"java.util.List\">\n        INSERT INTO t_referral_commission_record (\n            order_id, recipient_user_id, payer_user_id, commission_amount, commission_level,\n            commission_rate, status, currency, created_at, processed_at, referral_path, version, deleted\n        ) VALUES\n        <foreach collection=\"records\" item=\"record\" separator=\",\">\n            (\n                #{record.orderId}, #{record.recipientUserId}, #{record.payerUserId}, \n                #{record.commissionAmount}, #{record.commissionLevel}, #{record.commissionRate}, \n                #{record.status}, #{record.currency}, #{record.createdAt}, #{record.processedAt}, \n                #{record.referralPath}, #{record.version}, #{record.deleted}\n            )\n        </foreach>\n    </insert>\n    \n    <!-- 批量更新佣金记录状态 -->\n    <update id=\"updateStatusBatch\">\n        UPDATE t_referral_commission_record\n        SET status = #{status}, processed_at = NOW()\n        WHERE id IN\n        <foreach collection=\"ids\" item=\"id\" open=\"(\" separator=\",\" close=\")\">\n            #{id}\n        </foreach>\n        AND deleted = 0\n    </update>\n    \n    <!-- 根据订单ID删除佣金记录 -->\n    <delete id=\"deleteByOrderId\" parameterType=\"Long\">\n        UPDATE t_referral_commission_record\n        SET deleted = 1, updated_at = NOW()\n        WHERE order_id = #{orderId}\n    </delete>\n    \n    <!-- 查询所有佣金记录 -->\n    <select id=\"selectAll\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE deleted = 0\n        ORDER BY created_at DESC\n    </select>\n    \n    <!-- 查询系统佣金统计信息 -->\n    <select id=\"selectCommissionStatistics\" resultType=\"java.util.Map\">\n        SELECT \n            commission_level,\n            COUNT(*) as record_count,\n            SUM(commission_amount) as total_amount,\n            AVG(commission_amount) as avg_amount,\n            SUM(CASE WHEN status = 'paid' THEN commission_amount ELSE 0 END) as paid_amount,\n            SUM(CASE WHEN status = 'pending' THEN commission_amount ELSE 0 END) as pending_amount,\n            SUM(CASE WHEN status = 'failed' THEN commission_amount ELSE 0 END) as failed_amount\n        FROM t_referral_commission_record\n        WHERE deleted = 0\n        GROUP BY commission_level\n        ORDER BY commission_level\n    </select>\n    \n    <!-- 查询待处理的佣金记录 -->\n    <select id=\"selectPendingRecords\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE status = 'pending' AND deleted = 0\n        ORDER BY created_at ASC\n        <if test=\"limit != null and limit > 0\">\n            LIMIT #{limit}\n        </if>\n    </select>\n    \n    <!-- 查询过期的佣金记录 -->\n    <select id=\"selectExpiredRecords\" resultMap=\"TReferralCommissionRecordResult\">\n        <include refid=\"selectTReferralCommissionRecordVo\"/>\n        WHERE status = 'pending' AND created_at < #{expireDate} AND deleted = 0\n        ORDER BY created_at ASC\n    </select>\n    \n</mapper>"