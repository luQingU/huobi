<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"com.ruoyi.bussiness.mapper.referral.TReferralCommissionConfigMapper\">\n    \n    <resultMap type=\"TReferralCommissionConfig\" id=\"TReferralCommissionConfigResult\">\n        <result property=\"id\" column=\"id\" />\n        <result property=\"level\" column=\"level\" />\n        <result property=\"amount\" column=\"amount\" />\n        <result property=\"currency\" column=\"currency\" />\n        <result property=\"active\" column=\"active\" />\n        <result property=\"createdAt\" column=\"created_at\" />\n        <result property=\"updatedAt\" column=\"updated_at\" />\n        <result property=\"remarks\" column=\"remarks\" />\n        <result property=\"version\" column=\"version\" />\n        <result property=\"deleted\" column=\"deleted\" />\n        <result property=\"minOrderAmount\" column=\"min_order_amount\" />\n        <result property=\"maxCommissionAmount\" column=\"max_commission_amount\" />\n        <result property=\"validFrom\" column=\"valid_from\" />\n        <result property=\"validTo\" column=\"valid_to\" />\n        <result property=\"sortOrder\" column=\"sort_order\" />\n    </resultMap>\n    \n    <sql id=\"selectTReferralCommissionConfigVo\">\n        SELECT id, level, amount, currency, active, created_at, updated_at, remarks, version, deleted,\n               min_order_amount, max_commission_amount, valid_from, valid_to, sort_order\n        FROM t_referral_commission_config\n    </sql>\n    \n    <!-- 查询所有激活的佣金配置 -->\n    <select id=\"selectActiveConfigs\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE active = 1 AND deleted = 0\n        ORDER BY level ASC\n    </select>\n    \n    <!-- 根据级别查询佣金配置 -->\n    <select id=\"selectByLevel\" parameterType=\"Integer\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE level = #{level} AND deleted = 0\n        LIMIT 1\n    </select>\n    \n    <!-- 根据级别查询激活的佣金配置 -->\n    <select id=\"selectActiveBylevel\" parameterType=\"Integer\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE level = #{level} AND active = 1 AND deleted = 0\n        LIMIT 1\n    </select>\n    \n    <!-- 批量插入佣金配置 -->\n    <insert id=\"insertBatch\" parameterType=\"java.util.List\">\n        INSERT INTO t_referral_commission_config (\n            level, amount, currency, active, created_at, updated_at, remarks, version, deleted\n        ) VALUES\n        <foreach collection=\"configs\" item=\"config\" separator=\",\">\n            (\n                #{config.level}, #{config.amount}, #{config.currency}, #{config.active}, \n                #{config.createdAt}, #{config.updatedAt}, #{config.remarks}, #{config.version}, #{config.deleted}\n            )\n        </foreach>\n    </insert>\n    \n    <!-- 批量更新佣金配置 -->\n    <update id=\"updateBatch\" parameterType=\"java.util.List\">\n        <foreach collection=\"configs\" item=\"config\" separator=\";\">\n            UPDATE t_referral_commission_config\n            SET amount = #{config.amount}, currency = #{config.currency}, active = #{config.active}, \n                updated_at = #{config.updatedAt}, remarks = #{config.remarks}, version = version + 1\n            WHERE id = #{config.id} AND deleted = 0\n        </foreach>\n    </update>\n    \n    <!-- 删除所有佣金配置 -->\n    <update id=\"deleteAll\">\n        UPDATE t_referral_commission_config\n        SET deleted = 1, updated_at = NOW()\n        WHERE deleted = 0\n    </update>\n    \n    <!-- 查询总配置数量 -->\n    <select id=\"countTotalConfigs\" resultType=\"Integer\">\n        SELECT COUNT(*) FROM t_referral_commission_config WHERE deleted = 0\n    </select>\n    \n    <!-- 查询激活配置数量 -->\n    <select id=\"countActiveConfigs\" resultType=\"Integer\">\n        SELECT COUNT(*) FROM t_referral_commission_config WHERE active = 1 AND deleted = 0\n    </select>\n    \n    <!-- 根据货币类型查询佣金配置 -->\n    <select id=\"selectByCurrency\" parameterType=\"String\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE currency = #{currency} AND deleted = 0\n        ORDER BY level ASC\n    </select>\n    \n    <!-- 根据货币类型查询激活的佣金配置 -->\n    <select id=\"selectActiveByCurrency\" parameterType=\"String\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE currency = #{currency} AND active = 1 AND deleted = 0\n        ORDER BY level ASC\n    </select>\n    \n    <!-- 按级别排序查询激活配置 -->\n    <select id=\"selectActiveConfigsOrderByLevel\" resultMap=\"TReferralCommissionConfigResult\">\n        <include refid=\"selectTReferralCommissionConfigVo\"/>\n        WHERE active = 1 AND deleted = 0\n        ORDER BY level ASC\n    </select>\n    \n    <!-- 更新配置激活状态 -->\n    <update id=\"updateActiveStatus\">\n        UPDATE t_referral_commission_config\n        SET active = #{active}, updated_at = NOW(), version = version + 1\n        WHERE level = #{level} AND deleted = 0\n    </update>\n    \n    <!-- 检查级别是否存在 -->\n    <select id=\"existsByLevel\" parameterType=\"Integer\" resultType=\"Boolean\">\n        SELECT COUNT(*) > 0 FROM t_referral_commission_config \n        WHERE level = #{level} AND deleted = 0\n    </select>\n    \n    <!-- 查询最大级别 -->\n    <select id=\"selectMaxLevel\" resultType=\"Integer\">\n        SELECT COALESCE(MAX(level), 0) FROM t_referral_commission_config \n        WHERE deleted = 0\n    </select>\n    \n    <!-- 查询最小级别 -->\n    <select id=\"selectMinLevel\" resultType=\"Integer\">\n        SELECT COALESCE(MIN(level), 1) FROM t_referral_commission_config \n        WHERE deleted = 0\n    </select>\n    \n</mapper>"